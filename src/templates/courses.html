<!DOCTYPE html>
<html>
<head>
    <title>课程管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="/static/js/api.js"></script>
    <style>
        .action-buttons {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        .content-area {
            padding: 20px;
            margin-left: 200px;
        }
        .search-area {
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        #addCourseForm, #viewCoursesArea, #deleteCourseArea, #modifyCourseArea {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .table-responsive {
            margin-top: 20px;
        }
        .time-slots {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        .weekday-slots, .time-slots {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .form-check {
            margin-bottom: 5px;
        }
        .time-slot-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .weekday-select, .time-select, .modify-weekday-select, .modify-time-select {
            flex: 1;
        }
        .remove-time-slot {
            width: auto;
        }
    </style>
</head>
<body>
    <div class="content-area">
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="showAddCourse()">添加课程</button>
            <button class="btn btn-danger" onclick="showDeleteCourse()">删除课程</button>
            <button class="btn btn-warning" onclick="showModifyCourse()">修改课程</button>
            <button class="btn btn-info" onclick="showViewCourses()">查看课程</button>
        </div>

        <div id="addCourseForm" style="display: none;">
            <h3>添加课程</h3>
            <form id="courseForm">
                <div class="form-group">
                    <label>课程名称:</label>
                    <input type="text" class="form-control" name="name" required>
                </div>
                <div class="form-group">
                    <label>学习时间:</label>
                    <select class="form-control" name="learn_time">
                        <option>大一</option>
                        <option>大二</option>
                        <option>大三</option>
                        <option>大四</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>学分:</label>
                    <input type="number" class="form-control" name="credit" required>
                </div>
                <div class="form-group">
                    <label>平时成绩占比:</label>
                    <input type="number" class="form-control" name="usual_score" max="100" required>
                </div>
                <div class="form-group">
                    <label>期中成绩占比:</label>
                    <input type="number" class="form-control" name="midterm_score" max="100" required>
                </div>
                <div class="form-group">
                    <label>期末成绩占比:</label>
                    <input type="number" class="form-control" name="final_score" max="100" required>
                </div>
                <div class="form-group">
                    <label>上课时间:</label>
                    <div id="timeSlotContainer">
                        <div class="time-slot-row">
                            <select class="form-control weekday-select">
                                <option value="">选择星期</option>
                                <option value="星期一">星期一</option>
                                <option value="星期二">星期二</option>
                                <option value="星期三">星期三</option>
                                <option value="星期四">星期四</option>
                                <option value="星期五">星期五</option>
                            </select>
                            <select class="form-control time-select">
                                <option value="">选择时间</option>
                                <option value="8:30-10:10">8:30-10:10</option>
                                <option value="10:30-12:10">10:30-12:10</option>
                                <option value="14:00-15:40">14:00-15:40</option>
                                <option value="16:00-17:40">16:00-17:40</option>
                                <option value="19:00-20:40">19:00-20:40</option>
                            </select>
                            <button type="button" class="btn btn-danger remove-time-slot">删除</button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary mt-2" id="addTimeSlot">添加时间段</button>
                </div>
                <button type="submit" class="btn btn-primary mt-3">添加</button>
            </form>
        </div>

        <div id="viewCoursesArea" style="display: none;">
            <h3>课程列表</h3>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>课程名称</th>
                            <th>学习时间</th>
                            <th>学分</th>
                            <th>考核方式</th>
                            <th>上课时间</th>
                        </tr>
                    </thead>
                    <tbody id="courseTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="deleteCourseArea" style="display: none;">
            <h3>删除课程</h3>
            <div class="form-group">
                <label>选择要删除的课程:</label>
                <select class="form-control" id="deleteCourseSelect">
                    <option value="">选择课程</option>
                </select>
            </div>
            <button type="button" class="btn btn-danger mt-3" onclick="deleteCourse()">删除</button>
        </div>

        <div id="modifyCourseArea" style="display: none;">
            <h3>修改课程</h3>
            <div class="form-group">
                <label>选择要修改的课程:</label>
                <select class="form-control" id="modifyCourseSelect">
                    <option value="">选择课程</option>
                </select>
            </div>
            <form id="modifyCourseForm">
                <div class="form-group">
                    <label>新课程名称:</label>
                    <input type="text" class="form-control" name="new_name" required>
                </div>
                <div class="form-group">
                    <label>新学习时间:</label>
                    <select class="form-control" name="new_learn_time">
                        <option>大一</option>
                        <option>大二</option>
                        <option>大三</option>
                        <option>大四</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>新:</label>
                    <input type="number" class="form-control" name="new_credit" required>
                </div>
                <div class="form-group">
                    <label>新平时成绩占比:</label>
                    <input type="number" class="form-control" name="new_usual_score" max="100" required>
                </div>
                <div class="form-group">
                    <label>新期中成绩占比:</label>
                    <input type="number" class="form-control" name="new_midterm_score" max="100" required>
                </div>
                <div class="form-group">
                    <label>新期末成绩占比:</label>
                    <input type="number" class="form-control" name="new_final_score" max="100" required>
                </div>
                <div class="form-group">
                    <label>新上课时间:</label>
                    <div id="modifyTimeSlotContainer">
                        <div class="time-slot-row">
                            <select class="form-control modify-weekday-select">
                                <option value="">选择星期</option>
                                <option value="星期一">星期一</option>
                                <option value="星期二">星期二</option>
                                <option value="星期三">星期三</option>
                                <option value="星期四">星期四</option>
                                <option value="星期五">星期五</option>
                            </select>
                            <select class="form-control modify-time-select">
                                <option value="">选择时间</option>
                                <option value="8:30-10:10">8:30-10:10</option>
                                <option value="10:30-12:10">10:30-12:10</option>
                                <option value="14:00-15:40">14:00-15:40</option>
                                <option value="16:00-17:40">16:00-17:40</option>
                                <option value="19:00-20:40">19:00-20:40</option>
                            </select>
                            <button type="button" class="btn btn-danger remove-time-slot">删除</button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary mt-2" id="addModifyTimeSlot">添加时间段</button>
                </div>
                <button type="submit" class="btn btn-warning mt-3">修改</button>
            </form>
        </div>
    </div>

    <script>
        // 刷新有数据的函数
        function refreshAllData() {
            loadCourses();
            loadCoursesForDelete();
            loadCoursesForModify();
        }

        function loadCourses() {
            window.getCourses()
                .then(response => {
                    if (response && response.success) {
                        // 更新课程表格
                        let html = '';
                        response.data.forEach(course => {
                            html += `
                                <tr>
                                    <td>${course.name}</td>
                                    <td>${course.learn_time}</td>
                                    <td>${course.credit}</td>
                                    <td>平时:${course.usual_score}% 期中:${course.midterm_score}% 期末:${course.final_score}%</td>
                                    <td>${course.times || ''}</td>
                                </tr>
                            `;
                        });
                        $('#courseTableBody').html(html);

                        // 更新删除课程的选择框
                        const deleteSelect = $('#deleteCourseSelect');
                        deleteSelect.empty();
                        deleteSelect.append('<option value="">选择课程</option>');
                        response.data.forEach(course => {
                            deleteSelect.append(`<option value="${course.id}">${course.name}</option>`);
                        });
                    }
                })
                .catch(error => {
                    console.error('加载课程列表失败:', error);
                });
        }

        function loadCoursesForDelete() {
            getCourses()
                .then(response => {
                    if (response.success) {
                        const select = $('#deleteCourseSelect');
                        select.empty();
                        select.append('<option value="">选择课程</option>');
                        response.data.forEach(course => {
                            select.append(`<option value="${course.id}">${course.name}</option>`);
                        });
                    }
                })
                .catch(error => {
                    console.error('加载课程列表失败:', error);
                });
        }

        function loadCoursesForModify() {
            getCourses()
                .then(response => {
                    if (response.success) {
                        const select = $('#modifyCourseSelect');
                        select.empty();
                        select.append('<option value="">选择课程</option>');
                        response.data.forEach(course => {
                            select.append(`<option value="${course.id}">${course.name}</option>`);
                        });
                    }
                })
                .catch(error => {
                    console.error('加载课程表失败:', error);
                });
        }

        // 删除课程
        function deleteCourse() {
            const courseId = $('#deleteCourseSelect').val();
            if (!courseId) {
                alert('请选择要删除的课程');
                return;
            }

            if (confirm('确定要删除这个课程吗？\n删除后将无法恢复，且相关的选课记录、成绩记录和作业记录也会被删除。')) {
                fetch(`/api/courses/${courseId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('课程删除成功');
                        $('#deleteCourseSelect').val('');  // 清空选择
                        refreshAllData();  // 刷新数据
                    } else {
                        throw new Error(data.message || '删除失败');
                    }
                })
                .catch(error => {
                    console.error('删除课程失败:', error);
                    alert('删除失败: ' + (error.message || '未知错误'));
                });
            }
        }

        // 添加时间段行
        function addTimeSlotRow(container) {
            const newRow = $(`
                <div class="time-slot-row">
                    <select class="form-control ${container === 'timeSlotContainer' ? 'weekday-select' : 'modify-weekday-select'}">
                        <option value="">选择星期</option>
                        <option value="星期一">星期一</option>
                        <option value="星期二">星期二</option>
                        <option value="星期三">星期三</option>
                        <option value="星期四">星期四</option>
                        <option value="星期五">星期五</option>
                    </select>
                    <select class="form-control ${container === 'timeSlotContainer' ? 'time-select' : 'modify-time-select'}">
                        <option value="">选择时间</option>
                        <option value="8:30-10:10">8:30-10:10</option>
                        <option value="10:30-12:10">10:30-12:10</option>
                        <option value="14:00-15:40">14:00-15:40</option>
                        <option value="16:00-17:40">16:00-17:40</option>
                        <option value="19:00-20:40">19:00-20:40</option>
                    </select>
                    <button type="button" class="btn btn-danger remove-time-slot">删除</button>
                </div>
            `);
            $(`#${container}`).append(newRow);
        }

        // 绑定添加时间段按钮事件
        $('#addTimeSlot').click(() => addTimeSlotRow('timeSlotContainer'));
        $('#addModifyTimeSlot').click(() => addTimeSlotRow('modifyTimeSlotContainer'));

        // 绑定删除时间段按钮事件
        $(document).on('click', '.remove-time-slot', function() {
            $(this).closest('.time-slot-row').remove();
        });

        // 修改表单提交处理
        $('#courseForm').submit(function(e) {
            e.preventDefault();
            
            // 获取所有时间段组合
            const timeSlots = [];
            const timeMap = new Map();  // 用于检查时间段重复

            $('#timeSlotContainer .time-slot-row').each(function() {
                const weekday = $(this).find('.weekday-select').val();
                const time = $(this).find('.time-select').val();
                if (weekday && time) {
                    const timeSlot = `${weekday} ${time}`;
                    
                    // 检查时间段是否重复
                    if (timeMap.has(timeSlot)) {
                        alert('错误：存在重复的时间段安排！');
                        e.preventDefault();
                        return false;
                    }
                    
                    timeMap.set(timeSlot, true);
                    timeSlots.push(timeSlot);
                }
            });
            
            const formData = {
                name: $('input[name="name"]').val(),
                learn_time: $('select[name="learn_time"]').val(),
                credit: $('input[name="credit"]').val(),
                usual_score: parseInt($('input[name="usual_score"]').val()),
                midterm_score: parseInt($('input[name="midterm_score"]').val()),
                final_score: parseInt($('input[name="final_score"]').val()),
                times: timeSlots.join('|')
            };

            // 验证数据
            if (!formData.name || !formData.credit || 
                isNaN(formData.usual_score) || isNaN(formData.midterm_score) || isNaN(formData.final_score)) {
                alert('请填写所有必要字段，并确保成绩为数字');
                return;
            }

            // 验证成绩占比总和
            const totalScore = formData.usual_score + formData.midterm_score + formData.final_score;
            if (totalScore !== 100) {
                alert('成绩占比之和必须为100%');
                return;
            }

            // 验证是否选择了时间段
            if (timeSlots.length === 0) {
                alert('请至少选择一个上课时间');
                return;
            }

            // 验证学分是否合理
            if (formData.credit <= 0 || formData.credit > 6) {
                if (!confirm('警告：课程学分似乎不在正常范围内（1-6学分）。\n是否确定添加？')) {
                    return;
                }
            }

            // 调用API添加课程
            window.addCourse(formData)
                .then(response => {
                    if (response.success) {
                        alert('课程添加成功');
                        $('#courseForm')[0].reset();
                        $('#timeSlotContainer').html('');
                        addTimeSlotRow('timeSlotContainer');
                        refreshAllData();
                    }
                })
                .catch(error => {
                    alert('添加失败: ' + error.message);
                });
        });

        // 修改课程选择处理
        $('#modifyCourseSelect').change(function() {
            const courseId = $(this).val();
            if (courseId) {
                getCourses()
                    .then(response => {
                        if (response.success) {
                            const course = response.data.find(c => c.id == courseId);
                            if (course) {
                                $('input[name="new_name"]').val(course.name);
                                $('select[name="new_learn_time"]').val(course.learn_time);
                                $('input[name="new_credit"]').val(course.credit);
                                $('input[name="new_usual_score"]').val(course.usual_score);
                                $('input[name="new_midterm_score"]').val(course.midterm_score);
                                $('input[name="new_final_score"]').val(course.final_score);

                                // 清除现有时间段
                                $('#modifyTimeSlotContainer').empty();

                                // 添加已有的时间段
                                if (course.times) {
                                    const timeSlots = course.times.split('|');
                                    timeSlots.forEach(slot => {
                                        const [weekday, time] = slot.split(' ');
                                        const newRow = $(`
                                            <div class="time-slot-row">
                                                <select class="form-control modify-weekday-select">
                                                    <option value="">选择星期</option>
                                                    <option value="星期一">星期一</option>
                                                    <option value="星期二">星期二</option>
                                                    <option value="星期三">星期三</option>
                                                    <option value="星期四">星期四</option>
                                                    <option value="星期五">星期五</option>
                                                </select>
                                                <select class="form-control modify-time-select">
                                                    <option value="">选择时间</option>
                                                    <option value="8:30-10:10">8:30-10:10</option>
                                                    <option value="10:30-12:10">10:30-12:10</option>
                                                    <option value="14:00-15:40">14:00-15:40</option>
                                                    <option value="16:00-17:40">16:00-17:40</option>
                                                    <option value="19:00-20:40">19:00-20:40</option>
                                                </select>
                                                <button type="button" class="btn btn-danger remove-time-slot">删除</button>
                                            </div>
                                        `);
                                        newRow.find('.modify-weekday-select').val(weekday);
                                        newRow.find('.modify-time-select').val(time);
                                        $('#modifyTimeSlotContainer').append(newRow);
                                    });
                                }
                                if ($('#modifyTimeSlotContainer').children().length === 0) {
                                    addTimeSlotRow('modifyTimeSlotContainer');
                                }
                            }
                        }
                    });
            }
        });

        // 修改提交修改表单的处理
        $('#modifyCourseForm').submit(function(e) {
            e.preventDefault();
            const courseId = $('#modifyCourseSelect').val();
            if (!courseId) {
                alert('请选择要修改的课程');
                return;
            }

            // 获取所有时间段组合
            const timeSlots = [];
            $('#modifyTimeSlotContainer .time-slot-row').each(function() {
                const weekday = $(this).find('.modify-weekday-select').val();
                const time = $(this).find('.modify-time-select').val();
                if (weekday && time) {
                    timeSlots.push(`${weekday} ${time}`);
                }
            });

            const formData = {
                name: $('input[name="new_name"]').val(),
                learn_time: $('select[name="new_learn_time"]').val(),
                credit: $('input[name="new_credit"]').val(),
                usual_score: parseInt($('input[name="new_usual_score"]').val()),
                midterm_score: parseInt($('input[name="new_midterm_score"]').val()),
                final_score: parseInt($('input[name="new_final_score"]').val()),
                times: timeSlots.join('|')
            };

            // 验证数据
            if (!formData.name || !formData.credit || 
                isNaN(formData.usual_score) || isNaN(formData.midterm_score) || isNaN(formData.final_score)) {
                alert('请填写所有必要字段，并确保成绩为数字');
                return;
            }

            // 验证成绩占比总和
            const totalScore = formData.usual_score + formData.midterm_score + formData.final_score;
            if (totalScore !== 100) {
                alert('成绩占比之和必须为100%');
                return;
            }

            // 验证是否选择了时间段
            if (timeSlots.length === 0) {
                alert('请至少选择一个上课时间');
                return;
            }

            window.updateCourse(courseId, formData)
                .then(response => {
                    if (response.success) {
                        alert('课程修改成功');
                        $('#modifyCourseForm')[0].reset();
                        $('#modifyTimeSlotContainer').html('');
                        addTimeSlotRow('modifyTimeSlotContainer');  // 添加一个空行
                        refreshAllData();
                    }
                })
                .catch(error => {
                    alert('修改失败: ' + error.message);
                });
        });

        // 页面加载时初始化数据
        $(document).ready(function() {
            showAddCourse();
            refreshAllData();  // 初始加载所有数据
            addTimeSlotRow('timeSlotContainer');
            addTimeSlotRow('modifyTimeSlotContainer');

            // 绑定删除按钮事件
            $('#deleteCourseBtn').off('click').on('click', function() {
                deleteCourse();
            });
        });

        // 切换页面时刷新数据
        function showAddCourse() {
            $('#addCourseForm').show();
            $('#viewCoursesArea, #deleteCourseArea, #modifyCourseArea').hide();
            refreshAllData();
        }

        function showDeleteCourse() {
            $('#deleteCourseArea').show();
            $('#addCourseForm, #viewCoursesArea, #modifyCourseArea').hide();
            refreshAllData();  // 刷新数据
        }

        function showModifyCourse() {
            $('#modifyCourseArea').show();
            $('#addCourseForm, #viewCoursesArea, #deleteCourseArea').hide();
            refreshAllData();
        }

        function showViewCourses() {
            $('#viewCoursesArea').show();
            $('#addCourseForm, #deleteCourseArea, #modifyCourseArea').hide();
            refreshAllData();
        }

        // 在修改课程时处理时间段
        $('#modifyCourseSelect').change(function() {
            const courseId = $(this).val();
            if (courseId) {
                getCourses()
                    .then(response => {
                        if (response.success) {
                            const course = response.data.find(c => c.id == courseId);
                            if (course) {
                                $('input[name="new_name"]').val(course.name);
                                $('select[name="new_learn_time"]').val(course.learn_time);
                                $('input[name="new_credit"]').val(course.credit);
                                $('input[name="new_usual_score"]').val(course.usual_score);
                                $('input[name="new_midterm_score"]').val(course.midterm_score);
                                $('input[name="new_final_score"]').val(course.final_score);

                                // 清除现有时间段
                                $('#modifyTimeSlotContainer').empty();

                                // 添加已有的时间段
                                if (course.times) {
                                    const timeSlots = course.times.split('|');
                                    timeSlots.forEach(slot => {
                                        const [weekday, time] = slot.split(' ');
                                        const newRow = $(`
                                            <div class="time-slot-row">
                                                <select class="form-control modify-weekday-select">
                                                    <option value="">选择星期</option>
                                                    <option value="星期一">星期一</option>
                                                    <option value="星期二">星期二</option>
                                                    <option value="星期三">星期三</option>
                                                    <option value="星期四">星期四</option>
                                                    <option value="星期五">星期五</option>
                                                </select>
                                                <select class="form-control modify-time-select">
                                                    <option value="">选择时间</option>
                                                    <option value="8:30-10:10">8:30-10:10</option>
                                                    <option value="10:30-12:10">10:30-12:10</option>
                                                    <option value="14:00-15:40">14:00-15:40</option>
                                                    <option value="16:00-17:40">16:00-17:40</option>
                                                    <option value="19:00-20:40">19:00-20:40</option>
                                                </select>
                                                <button type="button" class="btn btn-danger remove-time-slot">删除</button>
                                            </div>
                                        `);
                                        newRow.find('.modify-weekday-select').val(weekday);
                                        newRow.find('.modify-time-select').val(time);
                                        $('#modifyTimeSlotContainer').append(newRow);
                                    });
                                }
                                if ($('#modifyTimeSlotContainer').children().length === 0) {
                                    addTimeSlotRow('modifyTimeSlotContainer');
                                }
                            }
                        }
                    });
            }
        });

        // 在显示课程列表时格式化时间显示
        function formatTimeSlots(times) {
            if (!times) return '';
            return times.split('|').join('\n');  // 使用换行符分隔不同时间段
        }
    </script>
</body>
</html> 