<!DOCTYPE html>
<html>

<head>
  <title>管理员个人资料</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="/static/css/animations.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="/static/js/api.js"></script>
  <style>
    body {
      font-family: 'Microsoft YaHei', sans-serif;
      background-color: #f8f9fc;
    }

    .content-area {
      padding: 25px;
      max-width: 800px;
      margin: 0 auto;
    }

    .page-header {
      margin-bottom: 25px;
      border-bottom: 1px solid #e3e6f0;
      padding-bottom: 15px;
    }

    .page-header h3 {
      font-weight: 600;
      color: #4e73df;
      margin: 0;
    }

    .profile-card {
      background-color: white;
      padding: 25px;
      margin-bottom: 25px;
      border-radius: 10px;
      box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
      transition: all 0.3s ease;
    }

    .profile-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 0.5rem 2rem 0 rgba(58, 59, 69, 0.2);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .btn-update {
      background: linear-gradient(45deg, #4e73df, #36b9cc);
      border: none;
      color: white;
      font-weight: 600;
      padding: 10px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .btn-update:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    .avatar-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 20px;
    }

    .avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background-color: #4e73df;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      margin-bottom: 15px;
    }

    .success-message,
    .error-message {
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
      display: none;
    }

    .success-message {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .error-message {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>
</head>

<body>
  <div class="content-area">
    <div class="page-header">
      <h3><i class="fas fa-user-shield me-2"></i>管理员资料</h3>
    </div>

    <div class="success-message" id="successMessage">
      <strong>成功！</strong> 您的个人信息已更新。
    </div>

    <div class="error-message" id="errorMessage">
      <strong>错误！</strong> <span id="errorText"></span>
    </div>

    <div class="profile-card fade-in">
      <div class="avatar-container">
        <div class="avatar" id="avatarInitial"></div>
        <h4 id="adminName">加载中...</h4>
        <p id="adminId" class="text-muted">加载中...</p>
      </div>

      <form id="profileForm">
        <div class="form-group">
          <label class="form-label">用户名</label>
          <input type="text" class="form-control" id="username" readonly>
          <small class="form-text text-muted">用户名不可修改</small>
        </div>
        <div class="form-group">
          <label class="form-label">姓名</label>
          <input type="text" class="form-control" id="name" required>
        </div>
        <div class="form-group">
          <label class="form-label">管理员编号</label>
          <input type="text" class="form-control" id="adminIdField" required>
          <small class="form-text text-muted">请确保管理员编号格式正确</small>
        </div>
        <div class="form-group">
          <label class="form-label">密码修改</label>
          <input type="password" class="form-control mb-2" id="newPassword" placeholder="新密码">
          <input type="password" class="form-control" id="confirmPassword" placeholder="确认密码">
          <small class="form-text text-muted">如不修改密码请留空</small>
        </div>

        <button type="submit" class="btn btn-update ripple-btn"><i class="fas fa-save me-2"></i>保存更改</button>
      </form>
    </div>
  </div>

  <script>
    $(document).ready(function () {
      // 加载当前管理员信息
      loadCurrentAdminInfo();

      // 表单提交事件
      $('#profileForm').on('submit', function (e) {
        e.preventDefault();
        updateAdminInfo();
      });
    });

    // 加载当前管理员信息
    async function loadCurrentAdminInfo() {
      try {
        // 获取当前用户信息
        const userResponse = await fetch('/api/current-user');
        const userData = await userResponse.json();

        if (userData.success) {
          const username = userData.data.username;
          const adminId = userData.data.admin_id;

          $('#username').val(username);

          // 设置头像初始字母
          $('#avatarInitial').text(username.charAt(0).toUpperCase());

          // 获取管理员详细信息
          const adminResponse = await fetch(`/api/admins/${adminId}/profile`);
          const adminData = await adminResponse.json();

          if (adminData.success) {
            const admin = adminData.data;
            $('#adminName').text(admin.name);
            $('#adminId').text(admin.admin_id);
            $('#name').val(admin.name);
            $('#adminIdField').val(admin.admin_id);
          } else {
            showError('无法加载管理员信息');
          }
        } else {
          showError('无法获取当前用户信息');
        }
      } catch (error) {
        console.error('加载管理员信息失败:', error);
        showError('加载个人信息时发生错误');
      }
    }

    // 更新管理员信息
    async function updateAdminInfo() {
      try {
        // 检查密码一致性
        const newPassword = $('#newPassword').val();
        const confirmPassword = $('#confirmPassword').val();

        if (newPassword && newPassword !== confirmPassword) {
          showError('两次输入的密码不一致');
          return;
        }

        // 获取当前用户信息以获取adminId
        const userResponse = await fetch('/api/current-user');
        const userData = await userResponse.json();

        if (!userData.success) {
          showError('无法获取当前用户信息');
          return;
        }

        const currentAdminId = userData.data.admin_id;

        // 准备更新数据
        const updateData = {
          name: $('#name').val(),
          admin_id: $('#adminIdField').val()
        };

        // 如果输入了新密码，添加到更新数据中
        if (newPassword) {
          updateData.new_password = newPassword;
        }

        // 发送更新请求
        const response = await fetch(`/api/admins/${currentAdminId}/profile`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(updateData)
        });

        const result = await response.json();

        if (result.success) {
          showSuccess();

          // 如果管理员ID已更改，刷新页面以使用新的ID
          if (currentAdminId !== updateData.admin_id) {
            setTimeout(() => {
              window.location.reload();
            }, 1500);
          } else {
            // 刷新显示的信息
            $('#adminName').text(updateData.name);
            $('#adminId').text(updateData.admin_id);

            // 清空密码字段
            $('#newPassword').val('');
            $('#confirmPassword').val('');
          }
        } else {
          showError(result.message || '更新失败');
        }
      } catch (error) {
        console.error('更新管理员信息失败:', error);
        showError('更新信息时发生错误');
      }
    }

    // 显示成功消息
    function showSuccess() {
      $('#successMessage').fadeIn().delay(3000).fadeOut();
    }

    // 显示错误消息
    function showError(message) {
      $('#errorText').text(message);
      $('#errorMessage').fadeIn().delay(5000).fadeOut();
    }
  </script>
</body>

</html>