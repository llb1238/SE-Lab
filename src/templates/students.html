<!DOCTYPE html>
<html>

<head>
    <title>学生管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/animations.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="/static/js/api.js"></script>
    <style>
        body {
            background-image: url('/static/picture/students.jpg');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            background-attachment: fixed;
            font-family: 'Microsoft YaHei', sans-serif;
        }

        .action-buttons {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-buttons button {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 6px;
        }

        .action-buttons button:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .content-area {
            padding: 30px;
            margin-left: 200px;
        }

        .search-area {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        #addStudentForm,
        #viewCoursesArea,
        #enrollCourseArea,
        #modifyStudentArea,
        #deleteStudentArea {
            margin-top: 25px;
            padding: 30px;
            background-color: rgba(248, 249, 250, 0.9);
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            animation: fadeIn 0.5s ease;
        }

        .form-control {
            border-radius: 8px;
            padding: 12px;
            border: 1px solid #ced4da;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, .25);
        }

        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
        }

        .table {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .table thead th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        h3,
        h4 {
            color: #343a40;
            margin-bottom: 20px;
            font-weight: 600;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            display: inline-block;
        }

        select.form-control {
            appearance: none;
            padding-right: 30px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath fill='%23343a40' d='M0 0l5 5 5-5z'/%3E%3C/svg%3E");
            background-position: right 10px center;
            background-repeat: no-repeat;
        }

        .hide-area {
            animation: fadeOut 0.3s ease forwards;
        }

        .show-area {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateY(20px);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div class="content-area">
        <h2 class="mb-4 text-white">学生管理系统</h2>

        <div class="action-buttons">
            <button class="btn btn-primary" onclick="showAddStudent()">注册学生</button>
            <button class="btn btn-success" onclick="showEnrollCourse()">报名课程</button>
            <button class="btn btn-warning" onclick="showModifyStudent()">修改学生信息</button>
            <button class="btn btn-danger" onclick="showDeleteStudent()">删除学生</button>
            <button class="btn btn-info" onclick="showViewCourses()">查看选课</button>
        </div>

        <!-- 注册学生表单 -->
        <div id="addStudentForm" style="display: none;">
            <h3>注册学生</h3>
            <form id="studentForm">
                <div class="form-group">
                    <label class="form-label">学生姓名:</label>
                    <input type="text" class="form-control" name="name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">学号:</label>
                    <input type="text" class="form-control" name="student_id" required>
                </div>
                <button type="submit" class="btn btn-primary mt-3">注册</button>
            </form>
        </div>

        <!-- 修改查看选课部分的HTML -->
        <div id="viewCoursesArea" style="display: none;">
            <h3>查看学生选课</h3>
            <div class="form-group">
                <label class="form-label">搜索学生:</label>
                <input type="text" class="form-control" id="viewStudentSearch" placeholder="输入学号或姓名搜索">
                <select class="form-control mt-2" id="studentSelect">
                    <option value="">选择学生</option>
                </select>
            </div>
            <div class="mt-3">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>课程名称</th>
                            <th>学时</th>
                            <th>学分</th>
                            <th>上课时间</th>
                        </tr>
                    </thead>
                    <tbody id="studentCoursesTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 报名课程区域 -->
        <div id="enrollCourseArea" style="display: none;">
            <h3>报名课程</h3>
            <div class="form-group">
                <label class="form-label">选择学生:</label>
                <select class="form-control" id="enrollStudentSelect">
                    <option value="">选择学生</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">选择课程:</label>
                <select class="form-control" id="enrollCourseSelect">
                    <option value="">选择课程</option>
                </select>
            </div>
            <button class="btn btn-primary mt-3" onclick="enrollCourse()">报名</button>
        </div>

        <!-- 修改学生信息区域 -->
        <div id="modifyStudentArea" style="display: none;">
            <h3>修改学生信息</h3>
            <div class="form-group">
                <label class="form-label">选择学生:</label>
                <select class="form-control" id="modifyStudentSelect">
                    <option value="">选择学生</option>
                </select>
            </div>
            <form id="modifyStudentForm">
                <div class="form-group">
                    <label class="form-label">新学生姓名:</label>
                    <input type="text" class="form-control" name="new_name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">新学号:</label>
                    <input type="text" class="form-control" name="new_student_id" required>
                </div>
                <button type="submit" class="btn btn-warning mt-3">修改</button>
            </form>
        </div>

        <!-- 删除学生区域 -->
        <div id="deleteStudentArea" style="display: none;">
            <h3>删除学生</h3>
            <div class="form-group">
                <label class="form-label">选择要删除的学生:</label>
                <select class="form-control" id="deleteStudentSelect">
                    <option value="">选择学生</option>
                </select>
            </div>
            <div class="alert alert-danger mt-3">
                <strong>警告:</strong> 删除学生将同时删除该学生的所有选课记录和成绩记录。此操作不可恢复。
            </div>
            <button type="button" id="deleteStudentButton" class="btn btn-danger mt-3">删除学生</button>
        </div>
    </div>

    <script>
        // 刷新所有数据的函数
        function refreshAllData() {
            loadStudents();
            loadCoursesForEnroll();
            const selectedStudentId = $('#studentSelect').val();
            if (selectedStudentId) {
                loadStudentCourses(selectedStudentId);
            }
        }

        // 加载学生列表
        function loadStudents() {
            window.getStudents()
                .then(response => {
                    if (response && response.success) {
                        window.studentsList = response.data;
                        updateStudentSelectors();
                    }
                })
                .catch(error => {
                    console.error('加载学生列表失败:', error);
                    alert('加载学生列表失败: ' + error.message);
                });
        }

        // 更新所有学生选择器
        function updateStudentSelectors() {
            const selectors = [
                $('#studentSelect'),
                $('#enrollStudentSelect'),
                $('#modifyStudentSelect'),
                $('#deleteStudentSelect')
            ];

            selectors.forEach(selector => {
                if (selector.length) {
                    selector.empty();
                    selector.append('<option value="">选择学生</option>');

                    if (window.studentsList && window.studentsList.length > 0) {
                        window.studentsList.forEach(student => {
                            const option = `<option value="${student.student_id}">
                                ${student.name} - ${student.student_id}
                            </option>`;
                            selector.append(option);
                        });
                    }
                }
            });
        }

        // 加载课程列表（用于报名课程）
        function loadCoursesForEnroll() {
            window.getCourses()
                .then(response => {
                    if (response && response.success) {
                        const select = $('#enrollCourseSelect');
                        select.empty();
                        select.append('<option value="">选择课程</option>');

                        window.coursesList = response.data;

                        response.data.forEach(course => {
                            select.append(`<option value="${course.id}">${course.name}</option>`);
                        });
                    }
                })
                .catch(error => {
                    console.error('加载课程列表失败:', error);
                });
        }

        // 查看学生课程
        function loadStudentCourses(studentId) {
            window.getStudentCourses(studentId)
                .then(response => {
                    if (response && response.success) {
                        let html = '';
                        if (response.data.length > 0) {
                            response.data.forEach(course => {
                                html += `
                                    <tr>
                                        <td>${course.name}</td>
                                        <td>${course.learn_time}</td>
                                        <td>${course.credit}</td>
                                        <td>${course.times || ''}</td>
                                    </tr>
                                `;
                            });
                        } else {
                            html = '<tr><td colspan="4">暂无课程数据</td></tr>';
                        }
                        $('#studentCoursesTableBody').html(html);
                    }
                })
                .catch(error => {
                    console.error('加载学生课程失败:', error);
                    $('#studentCoursesTableBody').html('<tr><td colspan="4">加载失败</td></tr>');
                });
        }

        // 注册学生
        $('#studentForm').submit(function (e) {
            e.preventDefault();

            const formData = {
                name: $('input[name="name"]').val(),
                student_id: $('input[name="student_id"]').val()
            };

            window.addStudent(formData)
                .then(response => {
                    if (response.success) {
                        alert('学生注册成功');
                        $('#studentForm')[0].reset();
                        refreshAllData();
                    }
                })
                .catch(error => {
                    alert('注册失败: ' + error.message);
                });
        });

        // 报名课程
        function enrollCourse() {
            const studentId = $('#enrollStudentSelect').val();
            const courseId = $('#enrollCourseSelect').val();

            if (!studentId || !courseId) {
                alert('请选择学生和课程');
                return;
            }

            window.addStudentCourse(studentId, courseId)
                .then(response => {
                    if (response.success) {
                        alert('课程报名成功');
                        refreshAllData();
                    }
                })
                .catch(error => {
                    alert('报名失败: ' + error.message);
                });
        }

        // 修改学生选择事件
        $('#studentSelect').change(function () {
            const studentId = $(this).val();
            if (studentId) {
                loadStudentCourses(studentId);
            } else {
                $('#studentCoursesTableBody').empty();
            }
        });

        // 修改学生选择框变化事件
        $('#modifyStudentSelect').change(function () {
            const studentId = $(this).val();
            if (studentId && window.studentsList) {
                const student = window.studentsList.find(s => s.student_id === studentId);
                if (student) {
                    $('input[name="new_name"]').val(student.name);
                    $('input[name="new_student_id"]').val(student.student_id);
                }
            }
        });

        // 提交修改学生表单
        $('#modifyStudentForm').submit(function (e) {
            e.preventDefault();
            const studentId = $('#modifyStudentSelect').val();
            if (!studentId) {
                alert('请选择要修改的学生');
                return;
            }

            const formData = {
                name: $('input[name="new_name"]').val(),
                student_id: $('input[name="new_student_id"]').val()
            };

            if (!formData.name || !formData.student_id) {
                alert('请填写所有必要字段');
                return;
            }

            window.updateStudent(studentId, formData)
                .then(response => {
                    if (response.success) {
                        alert('学生信息修改成功');
                        $('#modifyStudentForm')[0].reset();
                        refreshAllData();
                    }
                })
                .catch(error => {
                    alert('修改失败: ' + error.message);
                });
        });

        // 删除学生按钮点击事件
        $('#deleteStudentButton').on('click', function () {
            const studentId = $('#deleteStudentSelect').val();
            if (!studentId) {
                alert('请选择要删除的学生');
                return;
            }

            if (confirm('确定要删除这个学生吗？\n删除后将无法恢复，且相关的选课记录和成绩记录也会被删除。')) {
                window.deleteStudent(studentId)
                    .then(response => {
                        if (response && response.success) {
                            alert('学生删除成功');
                            $('#deleteStudentSelect').val('');
                            refreshAllData();
                        } else {
                            throw new Error(response.message || '删除失败');
                        }
                    })
                    .catch(error => {
                        alert('删除失败: ' + (error.message || '未知错误'));
                    });
            }
        });

        // 搜索学生
        $('#viewStudentSearch').on('input', function () {
            const searchText = $(this).val().toLowerCase();
            filterViewStudents(searchText);
        });

        // 过滤查看选课的学生
        function filterViewStudents(searchText) {
            const select = $('#studentSelect');
            select.empty();
            select.append('<option value="">选择学生</option>');

            if (!window.studentsList) return;

            const filteredStudents = window.studentsList.filter(student =>
                student.name.toLowerCase().includes(searchText) ||
                student.student_id.toLowerCase().includes(searchText)
            );

            filteredStudents.forEach(student => {
                select.append(`<option value="${student.student_id}">
                    ${student.name} - ${student.student_id}
                </option>`);
            });
        }

        // 修改页面切换动画效果 - 删除之前的重复定义，确保只有这一组函数
        function showAddStudent() {
            hideAllAreas();
            setTimeout(function () {
                $('#addStudentForm').show().addClass('show-area');
                refreshAllData();
            }, 300);
        }

        function showViewCourses() {
            hideAllAreas();
            setTimeout(function () {
                $('#viewCoursesArea').show().addClass('show-area');
                loadStudents();

                $('#viewStudentSearch').off('input').on('input', function () {
                    const searchText = $(this).val().trim();
                    filterViewStudents(searchText);
                });
            }, 300);
        }

        function showEnrollCourse() {
            hideAllAreas();
            setTimeout(function () {
                $('#enrollCourseArea').show().addClass('show-area');
                loadStudents();
                loadCoursesForEnroll();
            }, 300);
        }

        function showModifyStudent() {
            hideAllAreas();
            setTimeout(function () {
                $('#modifyStudentArea').show().addClass('show-area');
                loadStudents();
            }, 300);
        }

        function showDeleteStudent() {
            hideAllAreas();
            setTimeout(function () {
                $('#deleteStudentArea').show().addClass('show-area');
                loadStudents();
            }, 300);
        }

        function hideAllAreas() {
            $('#addStudentForm, #viewCoursesArea, #enrollCourseArea, #modifyStudentArea, #deleteStudentArea')
                .addClass('hide-area');
            setTimeout(function () {
                $('#addStudentForm, #viewCoursesArea, #enrollCourseArea, #modifyStudentArea, #deleteStudentArea')
                    .hide().removeClass('hide-area show-area');
            }, 300);
        }

        // 修改页面加载时初始化数据的逻辑，保持精简且与教师管理页面一致
        $(document).ready(function () {
            refreshAllData();
            showAddStudent(); // 默认显示添加学生页面

            // 添加表格行动画效果
            $(document).on('mouseenter', '.table tbody tr', function () {
                $(this).css({
                    'transform': 'translateY(-3px)',
                    'box-shadow': '0 5px 10px rgba(0,0,0,0.1)',
                    'z-index': '1',
                    'background-color': '#f8f9fa'
                });
            }).on('mouseleave', '.table tbody tr', function () {
                $(this).css({
                    'transform': '',
                    'box-shadow': '',
                    'z-index': '',
                    'background-color': ''
                });
            });

            // 添加按钮波纹效果
            $('.btn').addClass('ripple-btn');
        });

        // 添加加载全部学生函数，专门用于修改和删除功能
        function loadAllStudents() {
            window.getStudents()
                .then(response => {
                    if (response && response.success) {
                        // 更新删除学生选择器
                        const deleteSelect = $('#deleteStudentSelect');
                        deleteSelect.empty();
                        deleteSelect.append('<option value="">选择学生</option>');

                        // 更新修改学生选择器
                        const modifySelect = $('#modifyStudentSelect');
                        modifySelect.empty();
                        modifySelect.append('<option value="">选择学生</option>');

                        response.data.forEach(student => {
                            const option = `<option value="${student.student_id}">
                                ${student.name} - ${student.student_id}
                            </option>`;
                            deleteSelect.append(option);
                            modifySelect.append(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('加载学生列表失败:', error);
                });
        }

        // 用于查看选课的学生加载函数
        function loadStudentsForView() {
            window.getStudents()
                .then(response => {
                    if (response && response.success) {
                        window.studentsList = response.data;
                        filterViewStudents('');
                    }
                })
                .catch(error => {
                    console.error('加载学生列表失败:', error);
                });
        }

        // 用于选课的学生加载函数
        function loadStudentsForEnroll() {
            window.getStudents()
                .then(response => {
                    if (response && response.success) {
                        const select = $('#enrollStudentSelect');
                        select.empty();
                        select.append('<option value="">选择学生</option>');

                        response.data.forEach(student => {
                            select.append(`<option value="${student.student_id}">
                                ${student.name} - ${student.student_id}
                            </option>`);
                        });
                    }
                })
                .catch(error => {
                    console.error('加载学生列表失败:', error);
                });
        }
    </script>
</body>

</html>